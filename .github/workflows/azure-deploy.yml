name: Deploy to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY_NAME: ${{ secrets.AZURE_CONTAINER_REGISTRY }}
  REGISTRY_LOGIN_SERVER: ${{ secrets.AZURE_CONTAINER_REGISTRY }}.azurecr.io

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_LOGIN_SERVER }}
          username: ${{ secrets.AZURE_ACR_USERNAME }}
          password: ${{ secrets.AZURE_ACR_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push issuance-service
        uses: docker/build-push-action@v5
        with:
          context: ./backend/issuance-service
          file: ./backend/issuance-service/Dockerfile
          target: production
          push: true
          tags: |
            ${{ env.REGISTRY_LOGIN_SERVER }}/issuance-service:latest
            ${{ env.REGISTRY_LOGIN_SERVER }}/issuance-service:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY_LOGIN_SERVER }}/issuance-service:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY_LOGIN_SERVER }}/issuance-service:buildcache,mode=max

      - name: Build and push verification-service
        uses: docker/build-push-action@v5
        with:
          context: ./backend/verification-service
          file: ./backend/verification-service/Dockerfile
          target: production
          push: true
          tags: |
            ${{ env.REGISTRY_LOGIN_SERVER }}/verification-service:latest
            ${{ env.REGISTRY_LOGIN_SERVER }}/verification-service:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY_LOGIN_SERVER }}/verification-service:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY_LOGIN_SERVER }}/verification-service:buildcache,mode=max

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          target: production
          push: true
          build-args: |
            VITE_ISSUANCE_API_URL=${{ secrets.AZURE_APP_URL }}/api/issuance
            VITE_VERIFICATION_API_URL=${{ secrets.AZURE_APP_URL }}/api/verification
          tags: |
            ${{ env.REGISTRY_LOGIN_SERVER }}/frontend:latest
            ${{ env.REGISTRY_LOGIN_SERVER }}/frontend:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY_LOGIN_SERVER }}/frontend:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY_LOGIN_SERVER }}/frontend:buildcache,mode=max

  deploy-to-azure:
    name: Deploy to Azure Container Instances
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create deployment environment variables file
        run: |
          cat > azure-env.yaml <<EOF
          - name: NODE_ENV
            value: production
          - name: SYNC_SECRET
            secureValue: ${{ secrets.SYNC_SECRET }}
          - name: FRONTEND_URL
            value: ${{ secrets.AZURE_APP_URL }}
          - name: DATABASE_PATH
            value: /data/credentials.db
          EOF

      - name: Create YAML deployment file
        run: |
          cat > container-group.yaml <<EOF
          apiVersion: 2021-03-01
          location: ${{ secrets.AZURE_LOCATION }}
          name: kube-credential-app
          properties:
            containers:
            - name: frontend
              properties:
                image: ${{ env.REGISTRY_LOGIN_SERVER }}/frontend:latest
                resources:
                  requests:
                    cpu: 0.5
                    memoryInGb: 1
                ports:
                - port: 5173
                  protocol: TCP
                environmentVariables:
                - name: VITE_ISSUANCE_API_URL
                  value: ${{ secrets.AZURE_APP_URL }}/api/issuance
                - name: VITE_VERIFICATION_API_URL
                  value: ${{ secrets.AZURE_APP_URL }}/api/verification
            - name: issuance-service
              properties:
                image: ${{ env.REGISTRY_LOGIN_SERVER }}/issuance-service:latest
                resources:
                  requests:
                    cpu: 0.5
                    memoryInGb: 1
                ports:
                - port: 3001
                  protocol: TCP
                environmentVariables:
                - name: NODE_ENV
                  value: production
                - name: PORT
                  value: '3001'
                - name: DATABASE_PATH
                  value: /data/credentials.db
                - name: HOSTNAME
                  value: issuance-service
                - name: VERIFICATION_SERVICE_URL
                  value: http://localhost:3002
                - name: FRONTEND_URL
                  value: ${{ secrets.AZURE_APP_URL }}
                - name: SYNC_SECRET
                  secureValue: ${{ secrets.SYNC_SECRET }}
            - name: verification-service
              properties:
                image: ${{ env.REGISTRY_LOGIN_SERVER }}/verification-service:latest
                resources:
                  requests:
                    cpu: 0.5
                    memoryInGb: 1
                ports:
                - port: 3002
                  protocol: TCP
                environmentVariables:
                - name: NODE_ENV
                  value: production
                - name: PORT
                  value: '3002'
                - name: DATABASE_PATH
                  value: /data/verification.db
                - name: HOSTNAME
                  value: verification-service
                - name: ISSUANCE_SERVICE_URL
                  value: http://localhost:3001
                - name: FRONTEND_URL
                  value: ${{ secrets.AZURE_APP_URL }}
                - name: SYNC_SECRET
                  secureValue: ${{ secrets.SYNC_SECRET }}
            imageRegistryCredentials:
            - server: ${{ env.REGISTRY_LOGIN_SERVER }}
              username: ${{ secrets.AZURE_ACR_USERNAME }}
              password: ${{ secrets.AZURE_ACR_PASSWORD }}
            restartPolicy: Always
            osType: Linux
            ipAddress:
              type: Public
              dnsNameLabel: ${{ secrets.AZURE_DNS_NAME_LABEL }}
              ports:
              - protocol: TCP
                port: 5173
              - protocol: TCP
                port: 3001
              - protocol: TCP
                port: 3002
          tags: null
          type: Microsoft.ContainerInstance/containerGroups
          EOF

      - name: Deploy Container Group
        uses: azure/CLI@v1
        with:
          inlineScript: |
            # Delete existing container group if it exists
            az container delete \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --name kube-credential-app \
              --yes || true
            
            # Deploy new container group
            az container create \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
              --file container-group.yaml

      - name: Azure Logout
        if: always()
        run: az logout
